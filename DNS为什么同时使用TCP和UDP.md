# DNS为什么同时使用TCP和UDP
**区域传送时使用TCP，主要有一下两点考虑：**
1.辅域名服务器会定时（一般时3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，则会执行一次区域传送，进行数据同步。区域传送将使用TCP而不是UDP，因为数据同步传送的数据量比一个请求和应答的数据量要多得多。
2.TCP是一种可靠的连接，保证了数据的准确性。

**域名解析时使用UDP协议：**
客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。不用经过TCP三次握手，这样DNS服务器负载更低，响应更快。虽然从理论上说，客户端也可以指定向DNS服务器查询的时候使用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。

**UDP**
UDP 与 TCP 的主要区别在于 UDP 不一定提供可靠的数据传输。事实上，该协议不能保证数据准确无误地到达目的地。UDP 在许多方面非常有效。当某个程序的目标是尽快地传输尽可能多的信息时（其中任意给定数据的重要性相对较低），可使用 UDP。ICQ 短消息使用 UDP 协议发送消息。
许多程序将使用单独的TCP连接和单独的UDP连接。重要的状态信息随可靠的TCP连接发送，而主数据流通过UDP发送。

**TCP**
TCP的目的是提供可靠的数据传输，并在相互进行通信的设备或服务之间保持一个虚拟连接。TCP在数据包接收无序、丢失或在交付期间被破坏时，负责数据恢复。它通过为其发送的每个数据包提供一个序号来完成此恢复。记住，较低的网络层会将每个数据包视为一个独立的单元，因此，数据包可以沿完全不同的路径发送，即使它们都是同一消息的组成部分。这种路由与网络层处理分段和重新组装数据包的方式非常相似，只是级别更高而已。
为确保正确地接收数据，TCP要求在目标计算机成功收到数据时发回一个确认（即 ACK）。如果在某个时限内未收到相应的 ACK，将重新传送数据包。如果网络拥塞，这种重新传送将导致发送的数据包重复。但是，接收计算机可使用数据包的序号来确定它是否为重复数据包，并在必要时丢弃它。
**TCP是面向字节流的，而UDP是面向报文的**
我们知道，TCP具有序号机制，发送方会把一个大的HTTP报文按序号分割成若干个报文段加上TCP首部，也就是封装成TCP报文段，那么接收方在接收到这些TCP报文段后，就会按照序号以原来的顺序重组HTTP报文，着接收TCP面向字节流。
UDP面向报文，发送方的UDP对应用层交付下来的HTTP报文，在添加UDP首部后也就封装成UDP报文，就向下交付网络层IP协议，不做任何的拆分和合并，主要就是因为UDP没有像TCP一样的序列号机制来表示报文，所以默认只有一个UDP报文
UDP怎么做就会导致一个问题
互联网上物理链路层的最小传输单元=576字节，为了在物理链路上顺利传输，UDP报文不能超过576字节，为此，UDP报文被限制在512字节以内。
而DNS由于大面积使用UDP，这样一旦DNS报文超过512字节，基于UDP的DNS报文就只有抛弃多出来的64字节，截断为512字节，那么用户的到的DNS报文就不是完整的。
所以我们可以使用TCP来解决这个问题，尽管速度相对较慢，但是可以得到完整的DNS报文
**DNS在什么情况下使用UDP和TCP**
了解TCP面向字节流而UDP面向报文的这个特性后，在域名解析的时候，也就是客户端向DNS服务器查询域名获取IP地址的时候，DNS协议关于UDP和TCP的选择通常分为；两种情况：
1. 若客户端事先知道DNS响应的报文的长度会大于512字节，则应当直接使用TDP建立连接
2. 若客户端事先不知道DNS响应报文的长度，一般会先使用UDP协议发送DNS查询报文，若DNS服务器发现DNS响应报文长度大于512字节，则多出来的部分会被UDP抛弃，那么服务器会把这个被抛弃的DNS报文首部中的TC标志位置为1，以通知客户端该DNS已经被截断，客户端接收到之后会重新发送一次TCP请求，从而使它能够从DNS服务器收到完整的响应报文。
当然了，在域名解析的时候，一般返回的DNS响应报文都不会超过512字节，用UDP传输即可，事实上，很多DNS服务器进行配置的时候，也仅支持UDP查询包。
不过，DNS不仅存在域名解析的过程，含有区域传输的过程，而在进行区域传输的时候DNS会强制DNS使用TCP协议
**什么是区域传输**
设置域名服务器时，服务器管理员可以选择将域名服务器指定为主服务器还是辅助服务器（也称为从服务器）
主域名服务器负责维护一个区域所有域名信息，是特定的所用信息的权威信息源，数据可以修改。主服务器直接从本地文件获取此信息，只能在主服务器上修改区域的DNS记录，然后主服务器才能更新辅助服务器。
当主服务器出现故障的，关闭或负载过重时，辅助域名服务器作为主域名服务器的备份提供域名解析服务。辅助域名服务器中的区域文件中的数据是从主域名服务器中复制过来的，无法自行修改。
其实就是主从的概念，主域名服务器用来写，辅助域名服务器用来读，***提供负载均衡的能力，缓解主域名服务器的压力***
那么所谓的区域传输呢，就是辅助域名服务器与主域名服务器通信，并同步信息的过程
辅助域名服务器会定时向主域名服务器进行查询以便了解数据是否有改动，如果用改动，则会执行一次区域传输，区域传输使用TCP而不是UDP，***因为数据同步传输的数量比一个DNS请求和响应报文的数据多的多。***
