# CA证书
**数字证书**
一个数字证书通常包括了：
* 公钥；
* 持有者信息；
* 证书认证机构的信息；
* CA对这份文件的数字签名及使用的算法；
* 证书有效期；
* 还有一些其他额外信息；

数字证书的作用，是用来认证公钥持有者的身份，防止第三方进行冒充。简单来说，证书就是告诉客户端，这个服务器是否合法，因为只有证书合法，才能证明服务器身份是可靠的。
**数字证书签发和验证流程**
![Alt text](https://wx4.sinaimg.cn/mw2000/008sKdQply1h2oexwhwk3j30jy09gmzq.jpg)
CA 签发证书的过程：
* ⾸先 CA 会把持有者的公钥、⽤途、颁发者、有效时间等信息打成⼀个包，然后对这些信息进⾏ Hash 计算， 得到⼀个 Hash 值；
* 然后 CA 会使⽤⾃⼰的私钥将该 Hash 值加密，⽣成数字签名；
* 最后将数字签名添加在⽂件证书上，形成数字证书；

客户端校验服务端的数字证书的过程：
* ⾸先客户端会使⽤同样的 Hash 算法获取该证书的 Hash 值 H1；
* 通常浏览器和操作系统中集成了 CA 的公钥信息，浏览器收到证书后可以使⽤ CA 的公钥解密数字签名的内容，得到⼀个 Hash 值 H2 ；

最后⽐较 H1 和 H2，如果值相同，则为可信赖的证书，否则则认为证书不可信。
**证书的验证过程**
* 以百度为例，客户端收到baidu.com的证书后，发现这个证书的签发者不是根证书，就不能根据本地已有的根证书中的公钥去验证baidu.com证书是否可信。然后客户端根据baidu.com证书中的签发者，找到这个证书的颁发机构，然后向CA请求中间证书。
* 请求到证书后发现这个中间证书是由根证书签发的，应用会检查这个证书是否已经存在根证书清单上，如果有，就可以用根证书中的公钥去验证中间证书，如果发现验证通过，这个中间证书就是可信的。
* 然后中间证书被信任后，就可以用中间证书中的公钥去验证baidu.com证书的可信性，如果验证通过，就可以信任baidu.com证书。

最开始客户端只信任根证书，然后通过根证书信任中间证书，接着中间证书又信任baidu.com证书，最后客户端也就信任baidu.com证书了。

**为什么有这么多中间层级呢？**
为了确保根证书的绝对安全性，将根证书隔离地越严格越好，不然根证书如果失守了，那么整个信任链都会有问题。

**如何验证证书的真实性，如何防止证书被篡改？**
第一步，使用数字签名，通过一些摘要算法(MD5)为证书明文生成摘要，然后再用CA机构的私钥对生成的摘要加密生成数字签名。
第二步，客户端拿到证书后也用同样的摘要算法对证书明文计算摘要，对比看看是否被篡改了。
现在用CA的私钥对摘要加密之后，只有CA的公钥才能解密签名，如果客户端收到一个假的签名，使用CA的公钥是无法解密的，如果客户端收到了真的数字签名，但证书上的内容被篡改了，摘要对比也不会成功的，客户端就会认定这个证书非法。
**CA公钥如何安全地传输到客户端？**
这个公钥是存在CA证书上的，这个证书被操作系统信任，内置在操作系统上不需要传输。当服务器传输CA颁发的证书是，客户端收到证书后，使用内置的CA证书中的公钥来解密签名，验证就可以了，这样就解决了传输过程中被掉包的风险，因为根本就不用传输。
**如何防止证书被掉包？**
首先，任何人都可以向CA申请证书，第三方也不例外，所以这些证书都是合法的，如果客户端只验证签名的话，确实无法发现被掉包，但是客户端除了验证签名还会验证证书上的域名和自己要请求的域名是否一致，第三方虽然可以替换CA证书，但是域名不一致一样被认定非法。
