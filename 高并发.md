# 高并发
高并发是指在一个时间点，有很多用户同时访问url地址，比如：淘宝的双11，双12就会产生高并发，再比如：贴吧爆吧，就是恶意的高并发请求，也就是DDOS攻击。
**高并发常见的指标有**
* 响应时间：系统对请求作出回应的一个时间值，比如发起一个http请求，1庙后你得到了相应的相应，这个1秒就是响应时间。
* 吞吐量：系统在单位时间能够承受的最大访问量。
* 每秒查询数：系统每秒能够处理的查询次数。
* 用户并发数：同一时间系统能够承载正常系统的用户量。

**高并发产生的原因**
* 高并发的产生主要为了解决一些在高并发程序中由于程序可见性、原子性和有序性而引发的一些bug。
* 可见性：由于为了提高系统性能，我们增加了缓存机制，在多核cpu中每一个cpu都拥有自己的缓存，从而导致了cpu和内存之间的数据不一致。也就是说一个线程对某个共享变量的修改，其他线程不一定能够及时看到。
* 原子性：指程序的操作不可再分。比如 l = 1 + 2 就是一个不可再分的操作，如果是 l = a + 2，a是一个变量，这里就存在读取a的值，以及这个值与2做加法两个操作了，在多线程中由于a的值存在不确定性，所以可能导致程序出现问题。
* 有序性：指由于编译器的优化对程序指令进行了重新排序，从而在高并发环境下导致bug。比如：
```
int x=1;
int y=2;
int z=x+y;
```
cpu在指令重排序时，能保证x = 1和y = 2这两行代码在z = x + y上面，但是x = 1和y = 2的顺序就不一定了，在单线程中不会出现问题，但是在多线程中就不一定了。

**解决高并发的常用方法？**
大体分为两个方向，垂直方向和水平方向，垂直方向主要从硬件角度入手，通过增加服务器资源达到提高系统性能支持高并发的目的，增加服务器资源方式包括：增加内存、cpu核数、存储容量、将磁盘升级成SSD等方法。而书评方向主要是从软件设计的角度入手，通过对软件的各种架构组合方式，进行优化配置，从而达到提高系统性能支持高并发的目的。
**垂直方式常见的架构方式**
***集群化***
当一个服务器的处理能力有限时，我们就改考虑服务器集群了。服务器集群就是指将很多服务器几种起来一起进行同一种服务，在客户端看来就像只有一个服务器一样。集群可以利用多个计算机进行并行计算从而获得很高的计算速度，也可以用多个计算机做备份，从而使得任何一个机器坏了整个系统都能正常运行。就好比一个饭店原本只有一个厨师，但是由于生意越来越好，一个厨师忙不过来，就需要多找几个厨师一起做菜。
***分布式***
随着系统业务量的扩张，我们需要对系统的各个功能模块进行系统化，配套负载均衡技术使得系统能够承受的访问量和并发最大化。常用的负载均衡技术有：DNS负载均衡、硬件负载均衡、软件负载均衡。
* DNS负载均衡：DNS实现负载均衡是最基础简单的方式，一个域名通过DNS解析到多个IP，每个IP对应不同的服务器实例，这样就完成了流量的调度，虽然没有使用常规的负载均衡器，但实现了简单的负载均衡功能。
  1. DNS负载均衡的优点在于简单，成本低，负载均衡工作都交给DNS服务器来处理，不需要自己开发维护。
  2. 缺点就是更新不及时，DNS缓存的时间比较长，修改DNS配置后，由于缓存的原因，还是会有很多用户继续访问之前的IP，这样会造成访问失败，达不到负载均衡的目的；  分配策略太简单，DNS负载均衡支持的算法少，不能区分服务器的差异，无法感知后端服务器的状态，而且它不支持权重、hash等调度算法；

* 硬件负载均衡：不太了解，就知道是通过类似路由器、交换机这种硬件设备作为基础网络设备来实现负载均衡的功能。不太常用
* 软件负载均衡：通过软件实现负载均衡功能，常见的有Nginx和LVS，其中Nginx是7层负载均衡，LVS是Linux内核的4层负载均衡。4层和7层的区别在于协议和灵活性。Nginx支持http、e-mail协议；而LVS和协议无关，几乎所有应用都可以做，比如：聊天，数据库等。

**硬件和软件的区别**
软件和硬件的最主要区别就在于性能，硬件负载均衡性能远远高于软件负载均衡性能。Ngxin 的性能是万级，一般的 Linux 服务器上装一个 Nginx 大概能到 5 万 / 秒；LVS 的性能是十万级，据说可达到 80 万 / 秒；而 F5 性能是百万级，从 200 万 / 秒到 800 万 / 秒都有。当然，软件负载均衡的最大优势是比硬件负载均衡便宜。
