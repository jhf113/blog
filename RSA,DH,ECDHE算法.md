# RSA、DH、ECDHE算法
## RSA算法
RSA算法是最简单的密钥交换算法，所以它也有一些缺陷。
使用RSA密钥协商算法的最大问题是不支持前向保密。因为客户端传递随机数给服务器时使用的是公钥加密的，服务器收到后，会使用私钥解密得到随机数，所以一旦服务器的私钥泄漏了，之前被第三⽅截获的所有 TLS 通讯密⽂都会被破解。
## DH算法
DH算法可以解决RSA算法不具有前向保密的问题，但是它的计算效率比较低。
![Alt text](https://wx2.sinaimg.cn/mw2000/008sKdQply1h2qn3pluwwj30ml0h7n1g.jpg)
客户端和服务器各⾃会⽣成随机数，并以此作为私钥，然后根据公开的 DH 计算公示算出各⾃的公钥，通过 TLS 握⼿双⽅交换各⾃的公钥，这样双⽅都有⾃⼰的私钥和对⽅的公钥，然后双⽅根据各⾃持有的材料算出⼀个随机 数，这个随机数的值双⽅都是⼀样的，这就可以作为后续对称加密时使⽤的密钥。
DH 密钥交换过程中，即使第三⽅截获了 TLS 握⼿阶段传递的公钥，在不知道的私钥的情况下，也是⽆法计算出 密钥的，⽽且每⼀次对称加密密钥都是实时⽣成的，实现前向保密。
**DH 算法如何密钥交换**
DH算法是非对称加密算法，它的核心数学思想是离散对数。离散对数就是在对数的基础上进行取余运算。
首先客户端和服务端先确定模数和底数作为算法的参数（基于离散对数），这两个参数是公开的。
然后客户端和服务端各自生成一个随机数作为私钥，现在双方就都有了两个公开参数和各自的私钥，所以就可以计算出公钥。这个公式就是 公钥 = 〖底数〗^私钥  % 模数，这里我们假设双方的模数和底数为P和G，客户端生成的私钥为a，服务端生成的私钥是b，客户端生成的公钥记作A，服务端记作B，A = G^a  % P   B = G^b  % P。
生成的公钥AB也是公开的，因为离散对数，所以从真数(A,B)反过来计算对数(a,b)就非常困难，现在计算机也无法破解。
然后计算出公钥后，双方交换公钥，现在双方除了私钥不同，其他参数都是一样的。就可以对密钥进行计算了。客户端计算的公式 B^a  % P，服务端计算的公式 A^b  % P。因为离散对数得幂运算有交换律，所以双方最终的运算结果是一样的。这个结果就是客户端服务端之间的对称加密密钥，可以作为会话密钥使用。
在整个密钥协商过程中，客户端和服务端公开的信息有4个，首先是双方的模数和底数，然后是双方的公钥也是公开的，但是因为双方私钥都是各自保管的，第三方无法获得，只能从公开的4个参数入手去计算私钥，但是因为如果模数是个很大的数，即便是现在的计算机的计算能力也很难破解成功，所以DH密钥交换是安全的。
## ECDHE算法
ECDHE密钥协商算法是DH算法演进过来的，它既具有前向安全，同时计算效率也比DH算法高，所以被广泛应用于密钥交换算法。
ECDHE算法是在DHE算法的基础上利用了椭圆曲线特性，可以用更少的计算量计算出公钥，以及最终的会话密钥。

**ECDHE密钥交换算法过程：**
* 首先客户端服务端双方需要确定好使用哪种椭圆曲线，和曲线上的基点G，这两个参数都是公开的；
* 然后双方各自生成一个随机数作为私钥d，并和基点G相乘，得到公钥Q(Q = dG)，这是客户端的公私钥为Q1和d1，服务端的公私钥为Q2和d2；
* 双方交换各自的公钥，最后客户端计算点(x1，y1) = d1Q2，服务端计算点(x2，2) = d2Q1，因为椭圆曲线可以满足乘法交换和结合律，所以 d1Q2 = d1d2G = d2d1G = d2Q1，又因为双方的x坐标相同，所以它是共享密钥，也就是会话密钥。

ECDHE交换过程中，双方的私钥都是随机、临时生成的，都是不公开的，即使根据公开的信息（椭圆曲线、公钥、基点G）也很难计算出椭圆曲线上的离散对数（也就是私钥）
